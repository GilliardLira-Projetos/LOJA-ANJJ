<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CatÃ¡logo</title>

<style>
body{font-family:Arial;margin:0;padding:20px;background:#f6f6f6}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
h2{margin:0}
.cart-btn{background:#1d4ed8;color:#fff;border:none;padding:10px 16px;border-radius:6px;cursor:pointer;position:relative}
.cart-count{background:red;color:#fff;border-radius:50%;padding:2px 6px;font-size:12px;position:absolute;top:-6px;right:-6px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
.card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.1);display:flex;flex-direction:column}
.thumb{width:100%;height:160px;object-fit:cover;border-radius:8px;background:#eee}
.title{font-weight:bold;margin:8px 0}
.price{font-size:18px;margin-bottom:8px}
.oldprice{text-decoration:line-through;color:#888;font-size:14px}
select,input,button{padding:8px;border-radius:6px;border:1px solid #ccc}
button{background:#1d4ed8;color:#fff;border:none;cursor:pointer;transition:.3s;margin-top:8px}
button:hover{background:#2563eb}
#cartModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
#cartModal .box{background:#fff;padding:20px;border-radius:12px;width:90%;max-width:400px;max-height:80%;overflow-y:auto}
#cartModal h3{margin-top:0}
.item{border-bottom:1px solid #ddd;padding:8px 0}
.item:last-child{border:none}
.total{font-weight:bold;margin-top:12px}
.qty{width:60px;text-align:center;margin-left:8px}
</style>
</head>

<body>
<header>
  <h2>CatÃ¡logo</h2>
  <button class="cart-btn" onclick="openCart()">
    ðŸ›’ Carrinho <span class="cart-count" id="cartCount">0</span>
  </button>
</header>

<div id="products" class="grid"></div>

<!-- Modal do carrinho -->
<div id="cartModal">
  <div class="box">
    <h3>Seu carrinho</h3>
    <div id="cartItems"></div>
    <div class="total" id="cartTotal"></div>
    <button onclick="sendToWhatsApp()">Enviar no WhatsApp</button>
    <button onclick="closeCart()" style="background:#ccc;color:#000;margin-top:8px">Fechar</button>
  </div>
</div>

<script>
const SHEET_ID="1BqVAf9A7l7KHKcwpV9HrqBMPWTA4s-aPv1EEna7xuHg";
const SHEET_NAME="products";
const SHEET_URL=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
const WHATSAPP="5581997512217"; // <-- coloque seu nÃºmero com DDI

let cart=[];

function money(v){
  const n=Number(v);
  return isNaN(n)?v:n.toFixed(2).replace('.',',');
}

async function fetchSheet(){
  const r=await fetch(SHEET_URL);
  const t=await r.text();
  const j=JSON.parse(t.substring(t.indexOf("{"),t.lastIndexOf("}")+1));
  const cols=j.table.cols.map(c=>c.label.trim().toLowerCase());
  const rows=j.table.rows||[];
  return rows.map(row=>{
    const o={};
    row.c.forEach((c,i)=>{o[cols[i]]=c?(c.v??c.f??""):"";});
    return o;
  });
}

function groupProducts(data){
  const grouped={};
  data.forEach(p=>{
    if(String(p.availability).toLowerCase()!=="show")return;
    const name=String(p.name).trim();
    if(!name)return;
    if(!grouped[name])grouped[name]={name,variants:[],images:[]};
    const variantName=String(p["variant name"]).trim();
    if(variantName){
      grouped[name].variants.push({
        name:variantName,
        price:Number(p["discounted price"]||p.price)
      });
    }
    [p.thumbnail,p.image1,p.image2,p.image3].forEach(img=>{
      if(img&&!grouped[name].images.includes(img))grouped[name].images.push(img);
    });
  });
  return Object.values(grouped);
}

function addToCart(prod,variant,qty){
  if(qty<=0)return;
  cart.push({name:prod.name,variant:variant.name,price:variant.price,qty});
  document.getElementById("cartCount").textContent=cart.reduce((a,b)=>a+b.qty,0);
}

function openCart(){
  const modal=document.getElementById("cartModal");
  const items=document.getElementById("cartItems");
  const total=document.getElementById("cartTotal");
  items.innerHTML="";
  let sum=0;
  cart.forEach((it,i)=>{
    const subtotal=it.price*it.qty;
    sum+=subtotal;
    items.innerHTML+=`
      <div class="item">
        ${it.name} - ${it.variant} x${it.qty} <b>R$ ${money(subtotal)}</b>
      </div>`;
  });
  total.textContent="Total: R$ "+money(sum);
  modal.style.display="flex";
}

function closeCart(){
  document.getElementById("cartModal").style.display="none";
}

function sendToWhatsApp(){
  if(cart.length===0){alert("Seu carrinho estÃ¡ vazio.");return;}
  let msg="ðŸ›ï¸ *Pedido:*\n\n";
  let total=0;
  cart.forEach(it=>{
    const subtotal=it.price*it.qty;
    msg+=`â€¢ ${it.name} - ${it.variant} x${it.qty} = R$ ${money(subtotal)}\n`;
    total+=subtotal;
  });
  msg+=`\n*Total:* R$ ${money(total)}`;
  const url=`https://wa.me/${WHATSAPP}?text=${encodeURIComponent(msg)}`;
  window.open(url,"_blank");
}

function createCard(p){
  if(!p.variants.length)return null;
  const d=document.createElement("div");
  d.className="card";
  d.innerHTML=`
    <img class="thumb" src="${p.images[0]||""}" alt="${p.name}">
    <div class="title">${p.name}</div>
    <div class="price">R$ ${money(p.variants[0].price)}</div>
    <label>VariaÃ§Ã£o</label>
    <select class="variant">
      ${p.variants.map(v=>`<option value="${v.price}">${v.name}</option>`).join("")}
    </select>
    <label>Qtd</label>
    <input type="number" min="1" value="1" class="qty">
    <button>Adicionar ao carrinho</button>
  `;
  const sel=d.querySelector(".variant");
  const priceEl=d.querySelector(".price");
  const btn=d.querySelector("button");
  const qtyInput=d.querySelector(".qty");
  sel.onchange=()=>{priceEl.textContent="R$ "+money(sel.value)};
  btn.onclick=()=>{
    const idx=sel.selectedIndex;
    const qty=parseInt(qtyInput.value);
    addToCart(p,p.variants[idx],qty);
    alert(`${p.name} (${p.variants[idx].name}) x${qty} adicionado ao carrinho!`);
  };
  return d;
}

async function init(){
  const raw=await fetchSheet();
  const products=groupProducts(raw);
  const grid=document.getElementById("products");
  products.forEach(p=>{
    const c=createCard(p);
    if(c)grid.appendChild(c);
  });
}

init();
</script>
</body>
</html>
