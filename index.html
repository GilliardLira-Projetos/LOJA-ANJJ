<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1BqVAf9A7l7KHKcwpV9HrqBMPWTA4s-aPv1EEna7xuHg/gviz/tq?tqx=out:json&gid=1940306776";
let products = [];
let cart = [];

function money(v){return Number(v).toFixed(2).replace('.',',');}

async function fetchSheet(){
  const r = await fetch(SHEET_URL);
  const t = await r.text();
  // Remove o wrapper do GVIZ e transforma em JSON
  const j = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}")+1));
  const cols = j.table.cols.map(c=>c.label.trim().toLowerCase());
  const rows = j.table.rows||[];
  return rows.map(row=>{
    const o = {};
    row.c.forEach((c,i)=>o[cols[i]] = c ? (c.v??c.f??"") : "");
    return o;
  });
}

function groupProducts(data){
  const grouped = {};
  data.forEach(p=>{
    if(String(p.availability).toLowerCase()!=="show") return;
    const name = String(p.name).trim();
    if(!name) return;
    if(!grouped[name]){
      grouped[name] = {name, basePrice:Number(p.price), discounted:Number(p["discounted price"]||0), variants:[], images:[]};
    }
    const size = String(p["variant name"]).trim();
    if(size){
      grouped[name].variants.push({
        name:size,
        price: p["discounted price"] && p["discounted price"]<p.price? Number(p["discounted price"]): Number(p.price),
        stock:Number(p.stock||0)
      });
    }
    [p.thumbnail,p.image1,p.image2,p.image3].forEach(img=>{
      if(img && !grouped[name].images.includes(img)) grouped[name].images.push(img);
    });
  });
  return Object.values(grouped);
}

function createCard(p){
  if(!p.variants.length) return null;
  const d = document.createElement("div");
  d.className="card";
  d.innerHTML=`
    <img class="thumb" src="${p.images[0]||''}">
    <div class="title">${p.name}</div>
    <div class="price">R$ ${money(p.variants[0].price)}</div>
    <label>Tamanho</label>
    <select class="variant">${p.variants.map(v=>`<option value="${v.price}" data-stock="${v.stock}">${v.name}</option>`).join("")}</select>
    <label>Qtd</label>
    <select class="qty">${[...Array(p.variants[0].stock).keys()].map(i=>`<option>${i+1}</option>`).join("")}</select>
    <button class="add-cart">Adicionar ao Carrinho</button>
  `;
  const priceEl = d.querySelector(".price");
  const variantSel = d.querySelector(".variant");
  const qtySel = d.querySelector(".qty");
  
  variantSel.onchange = e=>{
    const selected = e.target.selectedOptions[0];
    priceEl.textContent = "R$ "+money(selected.value);
    const stock = Number(selected.dataset.stock);
    qtySel.innerHTML = [...Array(stock).keys()].map(i=>`<option>${i+1}</option>`).join("");
  }

  d.querySelector(".add-cart").onclick = ()=>{
    const variant = variantSel.value;
    const size = variantSel.selectedOptions[0].text;
    const qty = Number(qtySel.value);
    cart.push({name:p.name,variant:size,price:Number(variant),qty});
    updateCart();
  }

  return d;
}

function updateCart(){
  const container = document.getElementById("cartItems");
  container.innerHTML="";
  let total=0;
  cart.forEach((item,i)=>{
    const div=document.createElement("div");
    div.className="cart-item";
    div.innerHTML=`${item.name} (${item.variant}) x${item.qty} - R$ ${money(item.price*item.qty)}`;
    container.appendChild(div);
    total+=item.price*item.qty;
  });
  document.getElementById("cartTotal").textContent = money(total);
  document.getElementById("cartCount").textContent = cart.length;
}

function toggleCart(){document.getElementById("cartOverlay").classList.toggle("open");}

async function init(){
  const raw = await fetchSheet();
  products = groupProducts(raw);
  const grid = document.getElementById("catalog");
  products.forEach(p=>{
    const card = createCard(p);
    if(card) grid.appendChild(card);
  });
}

async function sendOrder(){
  const name = prompt("Digite seu nome (obrigat칩rio)");
  const phone = prompt("Digite seu WhatsApp (obrigat칩rio)");
  const email = prompt("Digite seu email (opcional)");
  if(!name||!phone){alert("Nome e WhatsApp obrigat칩rios!");return;}
  const total = cart.reduce((a,b)=>a+b.price*b.qty,0);
  const payload = {cliente:{name,phone,email},itens:cart,total};
  try{
    await fetch("https://script.google.com/macros/s/AKfycbyuVPU4P8UCniLdMHTyNv3Tq3bwK1AiQvCtzW5Li3dYeS7Ca0fMooskBcMDdIkV0_nS/exec",{method:"POST",body:JSON.stringify(payload)});
    const whatsappMsg = encodeURIComponent(`Ol치, ${name}, segue meu pedido:\n${cart.map(i=>`${i.name} (${i.variant}) x${i.qty}`).join("\n")}\nTotal: R$ ${money(total)}`);
    window.open(`https://wa.me/${phone}?text=${whatsappMsg}`,"_blank");
    cart=[]; updateCart(); toggleCart();
  }catch(err){console.error(err);alert("Erro ao enviar pedido");}
}

init();
</script>
