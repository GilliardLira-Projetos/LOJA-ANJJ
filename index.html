<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loja ANJJ</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .card { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; width: 250px; display: inline-block; vertical-align: top; }
  .thumb { width: 100%; height: 200px; object-fit: cover; }
  .cart-item { border-bottom: 1px solid #ccc; padding: 5px 0; }
  #cartOverlay { position: fixed; top:0; right:0; width: 300px; height: 100%; background:#f9f9f9; padding:20px; box-shadow: -3px 0 5px rgba(0,0,0,0.2); transform:translateX(100%); transition: transform 0.3s; overflow-y:auto; }
  #cartOverlay.open { transform: translateX(0); }
</style>
</head>
<body>

<h1>üèÜ LOJA ANJJ</h1>

<div id="catalog"></div>

<div id="cartOverlay">
  <h2>Carrinho</h2>
  <div id="cartItems"></div>
  <p>Total: R$ <span id="cartTotal">0,00</span></p>
  <label>Nome (obrigat√≥rio)<br>
    <input type="text" id="clientName">
  </label><br>
  <label>WhatsApp (obrigat√≥rio)<br>
    <input type="text" id="clientPhone">
  </label><br>
  <label>Email (opcional)<br>
    <input type="email" id="clientEmail">
  </label><br><br>
  <button onclick="sendOrder()">Enviar Pedido</button>
  <button onclick="clearCart()">Cancelar Pedido</button>
</div>

<button onclick="toggleCart()">Abrir/Fechar Carrinho (<span id="cartCount">0</span>)</button>

<script>
let cart = [];
let products = [];

// Fun√ß√£o auxiliar para formatar dinheiro
function money(value){ return Number(value).toFixed(2).replace('.',','); }

// Puxa os produtos direto da planilha p√∫blica
async function fetchSheet(){
  const url = "https://docs.google.com/spreadsheets/d/1BqVAf9A7l7KHKcwpV9HrqBMPWTA4s-aPv1EEna7xuHg/export?format=csv&gid=1940306776";
  const res = await fetch(url);
  const text = await res.text();

  const lines = text.trim().split("\n");
  const headers = lines[0].split(",").map(h => h.trim());
  const data = lines.slice(1).map(line => {
    const values = line.split(",").map(v => v.trim());
    const obj = {};
    headers.forEach((h,i)=> obj[h] = values[i] || "");
    // transforma images separadas por ; em array
    obj.images = obj.images ? obj.images.split(";") : [];
    return obj;
  });
  return data;
}

// Agrupa produtos por nome
function groupProducts(data){
  const grouped = {};
  data.forEach(p=>{
    if(String(p.availability).toLowerCase() !== "show") return;
    const name = String(p.name).trim();
    if(!name) return;
    if(!grouped[name]){
      grouped[name] = { 
        name, 
        basePrice: Number(p.price || 0), 
        discounted: Number(p.discounted_price || 0), 
        variants: [], 
        images: []
      };
    }
    const size = String(p["variant name"]).trim();
    if(size){
      grouped[name].variants.push({ name: size, price: Number(p.discounted_price || p.price) });
    }
    if(p.images) p.images.forEach(img=>{
      if(img && !grouped[name].images.includes(img)) grouped[name].images.push(img);
    });
  });
  return Object.values(grouped);
}

// Cria card do produto
function createCard(p){
  if(!p.variants.length) return null;
  const d = document.createElement("div");
  d.className = "card";
  d.innerHTML = `
    <img class="thumb" src="${p.images[0] || ''}">
    <h3>${p.name}</h3>
    <p class="price">R$ ${money(p.variants[0].price)}</p>
    <label>Tamanho
      <select class="variant">
        <option value="">Selecione o tamanho</option>
        ${p.variants.map(v=>`<option value="${v.price}">${v.name}</option>`).join('')}
      </select>
    </label><br>
    <label>Qtd
      <select class="qty" disabled>
        <option>Selecione a quantidade</option>
      </select>
    </label><br>
    <button class="add-cart" disabled>Adicionar ao Carrinho</button><br>
    <button class="prev">&lt;</button>
    <button class="next">&gt;</button>
  `;

  const priceEl = d.querySelector(".price");
  const variantSel = d.querySelector(".variant");
  const qtySel = d.querySelector(".qty");
  const addBtn = d.querySelector(".add-cart");
  const thumbImg = d.querySelector(".thumb");
  const prevBtn = d.querySelector(".prev");
  const nextBtn = d.querySelector(".next");

  let currentImg = 0;
  prevBtn.onclick = ()=>{ currentImg=(currentImg-1+p.images.length)%p.images.length; thumbImg.src=p.images[currentImg]; };
  nextBtn.onclick = ()=>{ currentImg=(currentImg+1)%p.images.length; thumbImg.src=p.images[currentImg]; };

  variantSel.onchange = e=>{
    const selected = e.target.selectedOptions[0];
    if(!selected.value){
      priceEl.textContent = "R$ 0,00";
      qtySel.innerHTML = `<option>Selecione a quantidade</option>`;
      qtySel.disabled = true;
      addBtn.disabled = true;
      return;
    }
    const price = Number(selected.value);
    priceEl.textContent = "R$ " + money(price);
    const stock = 10; // quantidade dispon√≠vel fixa, ou voc√™ pode pegar da planilha
    qtySel.innerHTML = [...Array(stock).keys()].map(i=>`<option value="${i+1}">${i+1}</option>`).join("");
    qtySel.disabled = false;
    addBtn.disabled = false;
  };

  addBtn.onclick = ()=>{
    const variant = variantSel.value;
    const size = variantSel.selectedOptions[0].text;
    const qty = Number(qtySel.value);
    cart.push({name: p.name, variant: size, price: Number(variant), qty});
    updateCart();
  };

  return d;
}

// Atualiza o carrinho
function updateCart(){
  const container = document.getElementById("cartItems");
  container.innerHTML = "";
  let total = 0;
  cart.forEach((item,i)=>{
    const div = document.createElement("div");
    div.className = "cart-item";
    div.innerHTML = `${item.name} (${item.variant}) x${item.qty} - R$ ${money(item.price*item.qty)}
      <button onclick="changeQty(${i},${item.qty-1})">-</button>
      <button onclick="changeQty(${i},${item.qty+1})">+</button>
      <button onclick="removeItem(${i})">X</button>
    `;
    container.appendChild(div);
    total += item.price * item.qty;
  });
  document.getElementById("cartTotal").textContent = money(total);
  document.getElementById("cartCount").textContent = cart.length;
}

// Carrinho
function changeQty(index,value){ if(value<=0) return removeItem(index); cart[index].qty = Number(value); updateCart(); }
function removeItem(index){ cart.splice(index,1); updateCart(); }
function toggleCart(){ document.getElementById("cartOverlay").classList.toggle("open"); }
function clearCart(){
  if(confirm("Deseja realmente cancelar o pedido?")){
    cart=[]; updateCart();
    document.getElementById("clientName").value='';
    document.getElementById("clientPhone").value='';
    document.getElementById("clientEmail").value='';
    toggleCart();
  }
}

// Envia pedido via WhatsApp
async function sendOrder(){
  const name=document.getElementById("clientName").value.trim();
  const phone=document.getElementById("clientPhone").value.trim();
  const email=document.getElementById("clientEmail").value.trim();
  if(!name||!phone){ alert("Nome e WhatsApp s√£o obrigat√≥rios!"); return; }
  if(cart.length===0){ alert("Carrinho vazio!"); return; }
  const total=cart.reduce((a,b)=>a+b.price*b.qty,0);
  const payload={cliente:{name,phone,email},itens:cart,total};

  try{
    // Substitua pela URL do seu Web App/Backend
    await fetch("URL_DO_SEU_WEB_APP_DO_DEPLOYD",{method:"POST",body:JSON.stringify(payload)});
    const whatsappMsg=encodeURIComponent(`Ol√°, sou ${name}, segue meu pedido:\n${cart.map(i=>`${i.name} (${i.variant}) x${i.qty}`).join("\n")}\nTotal: R$ ${money(total)}`);
    window.open(`https://wa.me/${phone.replace(/\D/g,'')}?text=${whatsappMsg}`,"_blank");
    clearCart();
  }catch(err){
    console.error(err);
    alert("Erro ao enviar pedido");
  }
}

// Inicializa√ß√£o
async function init(){
  const raw = await fetchSheet();
  products = groupProducts(raw);
  const grid = document.getElementById("catalog");
  products.forEach(p=>{
    const card = createCard(p);
    if(card) grid.appendChild(card);
  });
}

init();
</script>

</body>
</html>
