<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>LOJA ANJJ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <style>
        :root { --green: #16a34a; --red: #dc2626; --wpp: #25d366; --dark: #1e293b; }
        body { font-family: 'Poppins', sans-serif; margin: 0; background: #f8fafc; color: var(--dark); }
        header { padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #1a1a1a; z-index: 1000; color: white; }
        .cart-icon-btn { cursor: pointer; background: var(--green); color: white; padding: 8px 18px; border-radius: 30px; border: none; font-weight: bold; }
        .category-nav { display: flex; gap: 10px; padding: 10px 5%; overflow-x: auto; background: #fff; border-bottom: 1px solid #eee; }
        .cat-link { border: 1px solid #eee; padding: 6px 18px; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; }
        .cat-link.active { background: var(--green); color: #fff; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 20px 5%; }
        .card { border: 1px solid #eee; border-radius: 12px; padding: 10px; background: #fff; display: flex; flex-direction: column; position: relative; }
        .carousel-wrap { height: 180px; overflow: hidden; border-radius: 8px; margin-bottom: 8px; }
        .carousel-img { width: 100%; height: 100%; object-fit: cover; }
        .price-container { margin-bottom: 5px; }
        .current-price { font-weight: 700; color: var(--dark); }
        .old-price { font-size: 11px; color: #94a3b8; text-decoration: line-through; margin-right: 5px; }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #ddd; display: inline-block; margin: 2px; cursor: pointer; }
        .color-dot.selected { border: 2px solid #000; transform: scale(1.1); }
        .variant-chip { border: 1px solid #ddd; padding: 4px 8px; border-radius: 6px; font-size: 11px; display: inline-block; margin: 2px; cursor: pointer; }
        .variant-chip.selected { background: #000; color: #fff; }
        .btn-add { background: var(--green); color: #fff; border: none; padding: 10px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; margin-top: auto; }
        .cart-overlay { position: fixed; top: 0; right: 0; width: 100%; max-width: 380px; height: 100%; background: #fff; z-index: 2000; transform: translateX(100%); transition: 0.3s; display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
        .cart-overlay.open { transform: translateX(0); }
        .cart-body { flex: 1; overflow-y: auto; padding: 20px; }
        .input-order { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; display: none; z-index: 3000; }
    </style>
</head>
<body>

<header>
    <div style="font-weight:bold; letter-spacing:1px;">LOJA ANJJ</div>
    <button class="cart-icon-btn" onclick="toggleCart()">üõí <span id="cartCount">0</span></button>
</header>

<div class="category-nav" id="categoryNav">
    <div class="cat-link active" onclick="filterCat('all', this)">Tudo</div>
</div>

<div id="catalog"></div>

<div class="cart-overlay" id="cartOverlay">
    <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
        <b>Seu Carrinho</b>
        <button onclick="toggleCart()" style="border:none; background:none; font-size:24px;">&times;</button>
    </div>
    <div class="cart-body" id="cartItems"></div>
    <div style="padding:20px; border-top:1px solid #eee;">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:bold;">
            <span>Total:</span><span id="totalFinal">R$ 0,00</span>
        </div>
        <input type="text" id="custName" class="input-order" placeholder="Nome Completo">
        <input type="tel" id="custPhone" class="input-order" placeholder="WhatsApp com DDD">
        <button id="btnFinalizar" class="btn-add" style="background:var(--wpp); padding:15px;" onclick="finalizeOrder()">FECHAR PEDIDO NO WHATSAPP</button>
    </div>
</div>

<div id="toast"></div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/1uCx_JB4xZnU0vBIQjlrwBgsTRia_wSlUWPJlaN0EbhE/gviz/tq?tqx=out:json&sheet=Products";
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzjjtXHt9UkYeUhC3A2uh7vjN42-yUYdgfjJRhQFFhtIeqqc2BLsQrJmXSIOQ_3S2Abxg/exec";
const WHATSAPP_NUMBER = "5581997512217";

let productsData = [];
let cart = [];
const colorMap = { "preto": "black", "branco": "white", "vermelho": "red", "azul": "blue", "verde": "green", "marinho": "#000080" };

async function init() {
    try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1));
        const rows = json.table.rows.map(r => ({
            name: r.c[0]?.v || "",
            cat: r.c[1]?.v || "Geral",
            price: parseFloat(r.c[2]?.v || 0),
            promo: parseFloat(r.c[3]?.v || 0),
            size: String(r.c[5]?.v || ""),
            tag: String(r.c[6]?.v || ""),
            stock: parseInt(r.c[7]?.v || 0),
            show: String(r.c[8]?.v || "").toLowerCase() === "show",
            img: r.c[9]?.v || ""
        }));

        const grouped = {};
        rows.forEach(p => {
            if (!p.show) return;
            if (!grouped[p.name]) grouped[p.name] = { name: p.name, cat: p.cat, imgs: [p.img], skus: [] };
            grouped[p.name].skus.push(p);
        });

        productsData = Object.values(grouped);
        render();
    } catch (e) { console.error("Erro ao carregar:", e); }
}

function render() {
    const catalog = document.getElementById('catalog');
    catalog.innerHTML = "";
    productsData.forEach(p => {
        let grid = document.getElementById(`grid-${p.cat.replace(/\s/g,'')}`);
        if(!grid) {
            const sec = document.createElement('section');
            sec.id = `sec-${p.cat.replace(/\s/g,'')}`;
            sec.innerHTML = `<h2 style="padding:0 5%; font-size:16px; margin-top:20px;">${p.cat}</h2><div class="grid" id="grid-${p.cat.replace(/\s/g,'')}"></div>`;
            catalog.appendChild(sec);
            grid = document.getElementById(`grid-${p.cat.replace(/\s+/g,'')}`);
            
            const btn = document.createElement('div');
            btn.className = 'cat-link'; btn.innerText = p.cat;
            btn.onclick = (e) => filterCat(p.cat, e.target);
            document.getElementById('categoryNav').appendChild(btn);
        }
        grid.appendChild(createCard(p));
    });
}

function createCard(p) {
    const id = btoa(unescape(encodeURIComponent(p.name))).substring(0,10);
    const colors = [...new Set(p.skus.map(s => s.tag))];
    const sizes = [...new Set(p.skus.map(s => s.size))];
    const div = document.createElement('div');
    div.className = 'card';
    div.id = `card-${id}`;
    div.innerHTML = `
        <div class="carousel-wrap"><img src="${p.imgs[0]}" class="carousel-img"></div>
        <div class="price-container"><span class="old-price"></span><span class="current-price"></span></div>
        <div style="font-size:12px; font-weight:600; margin-bottom:8px; height:32px;">${p.name}</div>
        <div>${colors.map(c => `<div class="color-dot" data-val="${c}" onclick="sync('${id}','c','${c}')" style="background:${colorMap[c.toLowerCase()] || c}"></div>`).join('')}</div>
        <div style="margin:8px 0;">${sizes.map(s => `<div class="variant-chip" data-val="${s}" onclick="sync('${id}','s','${s}')">${s}</div>`).join('')}</div>
        <div style="font-size:10px; margin-bottom:8px;">Estoque: <b class="stk">0</b></div>
        <button class="btn-add" onclick="add('${id}')">ADICIONAR</button>
    `;
    setTimeout(() => { sync(id, 'c', colors[0]); sync(id, 's', sizes[0]); }, 100);
    return div;
}

function sync(id, type, val) {
    const card = document.getElementById(`card-${id}`);
    if(type === 'c') {
        card.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
        card.querySelector(`[data-val="${val}"]`).classList.add('selected');
    } else {
        card.querySelectorAll('.variant-chip').forEach(d => d.classList.remove('selected'));
        card.querySelector(`[data-val="${val}"]`).classList.add('selected');
    }
    const color = card.querySelector('.color-dot.selected').dataset.val;
    const size = card.querySelector('.variant-chip.selected').dataset.val;
    const product = productsData.find(p => btoa(unescape(encodeURIComponent(p.name))).substring(0,10) === id);
    const sku = product.skus.find(s => s.tag === color && s.size === size);

    if(sku) {
        card.querySelector('.current-price').innerText = `R$ ${sku.price.toFixed(2).replace('.',',')}`;
        card.querySelector('.stk').innerText = sku.stock;
        card.querySelector('.btn-add').disabled = sku.stock <= 0;
        card.querySelector('.btn-add').innerText = sku.stock <= 0 ? "ESGOTADO" : "ADICIONAR";
    }
}

function add(id) {
    const card = document.getElementById(`card-${id}`);
    const name = productsData.find(p => btoa(unescape(encodeURIComponent(p.name))).substring(0,10) === id).name;
    const color = card.querySelector('.color-dot.selected').dataset.val;
    const size = card.querySelector('.variant-chip.selected').dataset.val;
    const priceText = card.querySelector('.current-price').innerText.replace('R$ ','').replace(',','.');
    
    cart.push({ name, color, size, price: parseFloat(priceText) });
    updateCart();
    showToast("Adicionado!");
}

function updateCart() {
    document.getElementById('cartCount').innerText = cart.length;
    const itemsDiv = document.getElementById('cartItems');
    itemsDiv.innerHTML = cart.map((item, i) => `
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:13px; border-bottom:1px solid #eee; padding-bottom:5px;">
            <div><b>${item.name}</b><br><small>${item.color} | ${item.size}</small></div>
            <div>R$ ${item.price.toFixed(2)} <button onclick="remove(${i})" style="border:none; background:none;">üóëÔ∏è</button></div>
        </div>
    `).join('');
    const total = cart.reduce((a, b) => a + b.price, 0);
    document.getElementById('totalFinal').innerText = `R$ ${total.toFixed(2).replace('.',',')}`;
}

async function finalizeOrder() {
    const name = document.getElementById('custName').value;
    const phone = document.getElementById('custPhone').value;
    if(!name || !phone || cart.length === 0) return alert("Preencha os dados corretamente.");

    const btn = document.getElementById('btnFinalizar');
    btn.innerText = "SALVANDO PEDIDO...";
    btn.disabled = true;

    const itemsStr = cart.map(i => `${i.name} (${i.color}/${i.size})`).join(", ");
    const total = document.getElementById('totalFinal').innerText;

    // Envio para a Planilha (Orders)
    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ name, phone, items: itemsStr, total })
        });
    } catch (e) { console.log("Erro ao salvar planilha"); }

    // Envio para WhatsApp
    const msg = `*PEDIDO LOJA ANJJ*%0A*Cliente:* ${name}%0A*Whats:* ${phone}%0A*Itens:* ${itemsStr.replace(/,/g, '%0A')}%0A*TOTAL:* ${total}`;
    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`);
    
    btn.innerText = "PEDIDO ENVIADO!";
}

function remove(i) { cart.splice(i, 1); updateCart(); }
function toggleCart() { document.getElementById('cartOverlay').classList.toggle('open'); }
function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
function filterCat(c, el) {
    document.querySelectorAll('.cat-link').forEach(l => l.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('section').forEach(s => s.style.display = (c==='all' || s.id===`sec-${c.replace(/\s/g,'')}`) ? 'block' : 'none');
}

init();
</script>
</body>
</html>
            btn.innerText = p.category;
            btn.onclick = (e) => filterCat(p.category, e.target);
            document.getElementById('categoryNav').appendChild(btn);
        }
        grid.appendChild(createCard(p));
    });
}

function createCard(p) {
    const id = btoa(p.name).replace(/=/g,'');
    const colors = [...new Set(p.skus.map(s => s.color))];
    const sizes = [...new Set(p.skus.map(s => s.size))];
    const div = document.createElement('div');
    div.className = 'card';
    div.id = `card-${id}`;
    div.innerHTML = `
        <div class="carousel-wrap"><img src="${p.imgs[0]}" class="carousel-img active"></div>
        <div class="price-container"><span class="old-price"></span><span class="current-price"></span></div>
        <div style="font-size:12px; font-weight:600; margin-bottom:5px;">${p.name}</div>
        <div>${colors.map(c => `<div class="color-dot" onclick="sync('${id}','c','${c}')" style="background:${colorMap[c.toLowerCase()] || c}"></div>`).join('')}</div>
        <div style="margin:5px 0;">${sizes.map(s => `<div class="variant-chip" onclick="sync('${id}','s','${s}')">${s}</div>`).join('')}</div>
        <div style="font-size:10px;">Estoque: <b class="stk">0</b></div>
        <button class="btn-add" onclick="add('${id}')">ADICIONAR</button>
    `;
    setTimeout(() => { sync(id, 'c', colors[0]); sync(id, 's', sizes[0]); }, 50);
    return div;
}

function sync(id, type, val) {
    const card = document.getElementById(`card-${id}`);
    const name = atob(id);
    const p = productsData.find(x => x.name === name);
    
    if(type === 'c') {
        card.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
        card.querySelector(`[onclick*="'c','${val}'"]`)?.classList.add('selected');
    } else {
        card.querySelectorAll('.variant-chip').forEach(d => d.classList.remove('selected'));
        card.querySelector(`[onclick*="'s','${val}'"]`)?.classList.add('selected');
    }

    const c = card.querySelector('.color-dot.selected')?.getAttribute('onclick').split("'")[5];
    const s = card.querySelector('.variant-chip.selected')?.innerText;
    const sku = p.skus.find(x => x.color === c && x.size === s);

    if(sku) {
        card.querySelector('.current-price').innerText = `R$ ${sku.price.toFixed(2)}`;
        card.querySelector('.stk').innerText = sku.stock;
        card.querySelector('.btn-add').disabled = sku.stock <= 0;
    }
}

function add(id) {
    const card = document.getElementById(`card-${id}`);
    const name = atob(id);
    const color = card.querySelector('.color-dot.selected').getAttribute('onclick').split("'")[5];
    const size = card.querySelector('.variant-chip.selected').innerText;
    const p = productsData.find(x => x.name === name);
    const sku = p.skus.find(x => x.color === color && x.size === size);

    cart.push({ name, color, size, price: sku.price, img: p.imgs[0] });
    updateCart();
    showToast("Adicionado!");
}

function updateCart() {
    document.getElementById('cartCount').innerText = cart.length;
    const container = document.getElementById('cartItems');
    container.innerHTML = cart.map((item, i) => `
        <div style="display:flex; gap:10px; margin-bottom:10px; font-size:12px; border-bottom:1px solid #eee; padding-bottom:5px;">
            <img src="${item.img}" style="width:40px; height:40px; object-fit:cover;">
            <div style="flex:1;"><b>${item.name}</b><br>${item.color} | ${item.size}</div>
            <div>R$ ${item.price.toFixed(2)} <button onclick="removeItem(${i})">üóëÔ∏è</button></div>
        </div>
    `).join('');
    const total = cart.reduce((a, b) => a + b.price, 0);
    document.getElementById('totalFinal').innerText = `R$ ${total.toFixed(2)}`;
}

function removeItem(i) { cart.splice(i, 1); updateCart(); }

function finalizeOrder() {
    const n = document.getElementById('custName').value;
    const p = document.getElementById('custPhone').value;
    if(!n || !p) return alert("Preencha seus dados.");
    const items = cart.map(i => `- ${i.name} (${i.color}/${i.size})`).join('\n');
    const msg = `*NOVO PEDIDO*\nCliente: ${n}\n\nItens:\n${items}\n\n*Total: ${document.getElementById('totalFinal').innerText}*`;
    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`);
}

function toggleCart() { document.getElementById('cartOverlay').classList.toggle('open'); }
function showToast(m) { 
    const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 2000);
}
function filterCat(c, el) {
    document.querySelectorAll('.cat-link').forEach(l => l.classList.remove('active'));
    el.classList.add('active');
    document.querySelectorAll('.category-section').forEach(s => s.style.display = (c === 'all' || s.id === `sec-${c}`) ? 'block' : 'none');
}

init();
</script>
</body>
</html>
