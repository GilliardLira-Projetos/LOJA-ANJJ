<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LOJA ANJJ</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:Poppins,sans-serif;background:#f6f6f6}
header{background:#1d4ed8;color:#fff;padding:16px 24px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
.logo{font-size:22px;font-weight:600}
.cart-btn{background:#f59e0b;border:none;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;position:relative}
.cart-count{position:absolute;top:-6px;right:-6px;background:red;color:#fff;border-radius:50%;font-size:12px;padding:2px 6px}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;padding:20px}

.card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(0,0,0,.12);position:relative}

.thumb-container{height:230px;border-radius:10px;overflow:hidden;position:relative;cursor:pointer}
.thumb-container img{position:absolute;width:100%;height:100%;object-fit:cover;opacity:0;transition:.6s}
.thumb-container img.active{opacity:1}

.badge-sale{
 position:absolute;top:12px;left:12px;
 background:#dc2626;color:#fff;
 padding:6px 10px;font-size:12px;
 border-radius:6px;font-weight:600;z-index:10
}

.title{font-weight:600;margin:8px 0}
.price{margin:6px 0}

select,button{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;margin-top:6px}
.add-cart{background:#1d4ed8;color:#fff;border:none}

.cart-overlay{
 position:fixed;top:0;right:0;width:100%;max-width:420px;height:100%;
 background:#fff;box-shadow:-4px 0 20px rgba(0,0,0,.2);
 transform:translateX(100%);transition:.3s;z-index:2000;
 padding:20px;overflow:auto
}
.cart-overlay.open{transform:translateX(0)}

.cart-item{border-bottom:1px solid #eee;padding:6px 0}

.image-modal{
 display:none;position:fixed;top:0;left:0;width:100%;height:100%;
 background:rgba(0,0,0,.85);z-index:3000;
 justify-content:center;align-items:center
}
.image-modal.open{display:flex}
.image-modal img{max-width:90%;max-height:80%;border-radius:10px}
.image-modal .close{
 position:absolute;top:20px;right:20px;
 background:#000;color:#fff;border:none;
 width:40px;height:40px;border-radius:50%;
 font-size:22px;cursor:pointer
}
</style>
</head>

<body>

<header>
  <div class="logo">üèÜ LOJA ANJJ</div>
  <button class="cart-btn" onclick="toggleCart()">
    üõí Carrinho <span id="cartCount" class="cart-count">0</span>
  </button>
</header>

<section id="catalog" class="grid"></section>

<!-- CARRINHO -->
<div id="cartOverlay" class="cart-overlay">
  <h3>üõçÔ∏è Carrinho</h3>
  <div id="cartItems"></div>
  <p><strong>Total: R$ <span id="cartTotal">0,00</span></strong></p>
</div>

<!-- MODAL IMAGEM -->
<div id="imgModal" class="image-modal" onclick="closeModal(event)">
  <button class="close" onclick="closeModal()">‚úñ</button>
  <img id="modalImg">
</div>

<script>
const SHEET_URL =
"https://docs.google.com/spreadsheets/d/1BqVAf9A7l7KHKcwpV9HrqBMPWTA4s-aPv1EEna7xuHg/gviz/tq?tqx=out:json&sheet=Products";

let cart=[],currentImages=[],currentIndex=0;

const money=v=>Number(v).toFixed(2).replace('.',',');

async function fetchSheet(){
 const r=await fetch(SHEET_URL);
 const t=await r.text();
 const j=JSON.parse(t.substring(t.indexOf("{"),t.lastIndexOf("}")+1));
 const cols=j.table.cols.map(c=>c.label.toLowerCase());
 return j.table.rows.map(row=>{
  const o={};
  row.c.forEach((c,i)=>o[cols[i]]=c?c.v:"");
  return o;
 });
}

function groupProducts(data){
 const g={};
 data.forEach(p=>{
  if(String(p.availability).toLowerCase()!=="show")return;
  if(!g[p.name])g[p.name]={name:p.name,variants:[],images:[]};
  g[p.name].variants.push({
   name:p["variant name"]||"√önico",
   price:Number(p.price),
   discount:Number(p["discounted price"]||0),
   stock:Number(p.stock||1)
  });
  [p.thumbnail,p.image1,p.image2,p.image3].forEach(i=>{
   if(i&&!g[p.name].images.includes(i))g[p.name].images.push(i);
  });
 });
 return Object.values(g);
}

function createCard(p){
 const v=p.variants[0];
 const hasDiscount=v.discount>0 && v.discount<v.price;
 const percent=hasDiscount?Math.round(100-(v.discount/v.price)*100):0;

 const d=document.createElement("div");
 d.className="card";

 const imgs=p.images.map((s,i)=>`<img src="${s}" class="${i==0?'active':''}">`).join("");

 d.innerHTML=`
 ${hasDiscount?`<div class="badge-sale">PROMO ${percent}%</div>`:""}
 <div class="thumb-container">${imgs}</div>
 <div class="title">${p.name}</div>
 <div class="price">
 ${hasDiscount
 ?`<span style="text-decoration:line-through;color:#999">R$ ${money(v.price)}</span><br>
   <span style="color:#dc2626;font-size:20px">R$ ${money(v.discount)}</span>`
 :`R$ ${money(v.price)}`}
 </div>

 <label>Tamanho</label>
 <select class="variant">
   <option disabled selected>Selecionar</option>
   ${p.variants.map(v=>`
     <option value="${v.price}" data-discount="${v.discount}">
       ${v.name}
     </option>`).join("")}
 </select>

 <label>Qtd</label>
 <select class="qty">${[...Array(v.stock)].map((_,i)=>`<option>${i+1}</option>`).join("")}</select>

 <button class="add-cart">Adicionar</button>
 `;

 // slideshow autom√°tico
 const imgsEl=d.querySelectorAll("img");
 let idx=0;
 setInterval(()=>{
  imgsEl[idx].classList.remove("active");
  idx=(idx+1)%imgsEl.length;
  imgsEl[idx].classList.add("active");
 },3000);

 // modal
 d.querySelector(".thumb-container").onclick=()=>{
  currentImages=p.images;
  modalImg.src=currentImages[0];
  imgModal.classList.add("open");
 };

 d.querySelector(".add-cart").onclick=()=>{
  const sel=d.querySelector(".variant").selectedOptions[0];
  if(!sel){alert("Selecione o tamanho");return;}
  const price=Number(sel.dataset.discount||sel.value);
  const qty=Number(d.querySelector(".qty").value);
  cart.push({name:p.name,price,qty});
  updateCart();
 };

 return d;
}

function updateCart(){
 cartItems.innerHTML="";
 let total=0;
 cart.forEach(i=>{
  cartItems.innerHTML+=`<div class="cart-item">${i.name} x${i.qty} ‚Äì R$ ${money(i.price*i.qty)}</div>`;
  total+=i.price*i.qty;
 });
 cartTotal.textContent=money(total);
 cartCount.textContent=cart.length;
}

function toggleCart(){cartOverlay.classList.toggle("open");}
function closeModal(e){if(!e||e.target.id==="imgModal")imgModal.classList.remove("open");}

(async()=>{
 const raw=await fetchSheet();
 groupProducts(raw).forEach(p=>catalog.appendChild(createCard(p)));
})();
</script>

</body>
</html>
